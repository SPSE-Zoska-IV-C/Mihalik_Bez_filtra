{% extends 'base.html' %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Articles</h2>
    {% if current_user.is_authenticated %}
    <form method="post" action="{{ url_for('fetch_article') }}">
      <button type="submit" class="btn btn-warning">Fetch New Article</button>
    </form>
    {% endif %}
  </div>
  {% if articles %}
    <div class="row">
      {% for article in articles %}
        <div class="col-md-6 mb-4">
          <div class="card article-card h-100">
            <img 
              src="{{ article.cover_image_url(640, 360) }}" 
              data-fallback="{{ article.placeholder_image_url(640, 360) }}"
              class="card-img-top article-card-img" 
              alt="article image" 
              loading="lazy" 
              referrerpolicy="no-referrer" 
              onerror="this.onerror=null;this.src=this.dataset.fallback;" />
            <div class="card-body d-flex flex-column">
              <h4 class="card-title">
                <a href="{{ url_for('article_detail', article_id=article.id) }}" class="text-decoration-none article-card-link">
                  {{ article.title }}
                </a>
              </h4>
              <small class="text-muted d-block mb-2">
                by <strong>{{ article.author.username }}</strong> on {{ article.date_posted.strftime('%Y-%m-%d %H:%M') }}
              </small>
              <p class="card-text">
                {% if article.summary %}
                  {{ article.summary }}
                {% else %}
                  {% set sources_data = article.get_sources() %}
                  {% if sources_data and 'bullets' in sources_data %}
                    Key points from {{ sources_data.sources|length }} sources
                  {% elif sources_data %}
                    Coverage from {{ sources_data|length }} sources
                  {% else %}
                    {{ article.content[:180] + '...' if article.content|length > 180 else article.content }}
                  {% endif %}
                {% endif %}
              </p>
              
              {% if current_user.is_authenticated %}
              <div class="mt-auto">
                <a href="{{ url_for('article_detail', article_id=article.id) }}" class="btn btn-primary btn-sm">
                  Read More ‚Üí
                </a>
                {% if article.source_url %}
                <a href="{{ article.source_url }}" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm ms-2">Read full article</a>
                {% endif %}
                <button 
                  class="btn like-btn btn-sm ms-2 {% if user_reactions.get(article.id) and user_reactions[article.id].liked %}btn-success{% else %}btn-outline-primary{% endif %}" 
                  data-article-id="{{ article.id }}"
                  onclick="toggleLike({{ article.id }})"
                >
                  üëç
                </button>
                <span class="badge bg-primary ms-1 like-count-{{ article.id }}">
                  {{ article_stats[article.id].like_count }}
                </span>
              </div>
              {% else %}
              <a href="{{ url_for('article_detail', article_id=article.id) }}" class="btn btn-primary btn-sm mt-2">
                Read More ‚Üí
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>No articles yet. <a href="{{ url_for('add_article') }}">Add the first one</a>.</p>
  {% endif %}

  {% if current_user.is_authenticated %}
  <script>
    function toggleLike(articleId) {
      fetch(`/article/${articleId}/like`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const likeBtn = document.querySelector(`.like-btn[data-article-id="${articleId}"]`);
          if (data.liked) {
            likeBtn.classList.remove('btn-outline-primary');
            likeBtn.classList.add('btn-success');
          } else {
            likeBtn.classList.remove('btn-success');
            likeBtn.classList.add('btn-outline-primary');
          }
          const likeCount = document.querySelector(`.like-count-${articleId}`);
          likeCount.textContent = data.like_count;
        }
      })
      .catch(error => console.error('Error:', error));
    }
  </script>
  {% endif %}
{% endblock %}


