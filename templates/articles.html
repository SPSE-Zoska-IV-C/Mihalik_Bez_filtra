{% extends 'base.html' %}
{% block content %}
<div class="container-wide container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Articles</h2>
    {% if current_user.is_authenticated %}
    <form method="post" action="{{ url_for('fetch_article') }}">
      <button type="submit" class="btn btn-warning">Fetch New Article</button>
    </form>
    {% endif %}
  </div>
  
  <div class="row">
    <!-- Sidebar Filters -->
    <div class="col-lg-2 col-xl-2 mb-4 mb-lg-0">
      <div class="card filter-sidebar" style="position: sticky; top: 80px;">
        <div class="card-header">
          <h6 class="mb-0 fw-semibold">Filters</h6>
        </div>
        <div class="card-body p-2">
          <div class="accordion accordion-flush" id="filterAccordion">
            <!-- Countries Filter -->
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="headingCountries">
                <button class="accordion-button collapsed py-2 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCountries" aria-expanded="false" aria-controls="collapseCountries">
                  <small class="fw-semibold">Countries</small>
                </button>
              </h2>
              <div id="collapseCountries" class="accordion-collapse collapse" aria-labelledby="headingCountries" data-bs-parent="#filterAccordion">
                <div class="accordion-body p-2 pt-0">
                  <div class="d-flex flex-column gap-1">
                    <a href="{{ url_for('list_articles', filter='ukraine') }}" 
                       class="filter-link {% if current_filter == 'ukraine' %}active{% endif %}">
                      Ukraine
                    </a>
                    <a href="{{ url_for('list_articles', filter='israel') }}" 
                       class="filter-link {% if current_filter == 'israel' %}active{% endif %}">
                      Israel
                    </a>
                    <a href="{{ url_for('list_articles', filter='usa') }}" 
                       class="filter-link {% if current_filter == 'usa' %}active{% endif %}">
                      USA
                    </a>
                    <a href="{{ url_for('list_articles', filter='russia') }}" 
                       class="filter-link {% if current_filter == 'russia' %}active{% endif %}">
                      Russia
                    </a>
                    <a href="{{ url_for('list_articles', filter='china') }}" 
                       class="filter-link {% if current_filter == 'china' %}active{% endif %}">
                      China
                    </a>
                    <a href="{{ url_for('list_articles', filter='palestine') }}" 
                       class="filter-link {% if current_filter == 'palestine' %}active{% endif %}">
                      Palestine
                    </a>
                    <a href="{{ url_for('list_articles', filter='gaza') }}" 
                       class="filter-link {% if current_filter == 'gaza' %}active{% endif %}">
                      Gaza
                    </a>
                    <a href="{{ url_for('list_articles', filter='europe') }}" 
                       class="filter-link {% if current_filter == 'europe' %}active{% endif %}">
                      Europe
                    </a>
                    <a href="{{ url_for('list_articles', filter='uk') }}" 
                       class="filter-link {% if current_filter == 'uk' %}active{% endif %}">
                      United Kingdom
                    </a>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- News Type Filter -->
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="headingType">
                <button class="accordion-button collapsed py-2 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseType" aria-expanded="false" aria-controls="collapseType">
                  <small class="fw-semibold">News Type</small>
                </button>
              </h2>
              <div id="collapseType" class="accordion-collapse collapse" aria-labelledby="headingType" data-bs-parent="#filterAccordion">
                <div class="accordion-body p-2 pt-0">
                  <div class="d-flex flex-column gap-1">
                    <a href="{{ url_for('list_articles', filter='war') }}" 
                       class="filter-link {% if current_filter == 'war' %}active{% endif %}">
                      War
                    </a>
                    <a href="{{ url_for('list_articles', filter='speech') }}" 
                       class="filter-link {% if current_filter == 'speech' %}active{% endif %}">
                      Speech
                    </a>
                    <a href="{{ url_for('list_articles', filter='meeting') }}" 
                       class="filter-link {% if current_filter == 'meeting' %}active{% endif %}">
                      Meeting
                    </a>
                    <a href="{{ url_for('list_articles', filter='election') }}" 
                       class="filter-link {% if current_filter == 'election' %}active{% endif %}">
                      Election
                    </a>
                    <a href="{{ url_for('list_articles', filter='protest') }}" 
                       class="filter-link {% if current_filter == 'protest' %}active{% endif %}">
                      Protest
                    </a>
                    <a href="{{ url_for('list_articles', filter='economy') }}" 
                       class="filter-link {% if current_filter == 'economy' %}active{% endif %}">
                      Economy
                    </a>
                    <a href="{{ url_for('list_articles', filter='technology') }}" 
                       class="filter-link {% if current_filter == 'technology' %}active{% endif %}">
                      Technology
                    </a>
                    <a href="{{ url_for('list_articles', filter='climate') }}" 
                       class="filter-link {% if current_filter == 'climate' %}active{% endif %}">
                      Climate
                    </a>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Clear Filter -->
            {% if current_filter %}
            <div class="pt-2 border-top">
              <a href="{{ url_for('list_articles') }}" class="filter-link-clear">
                Clear Filters
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-10 col-xl-10">
      {% if current_search %}
      <div class="alert alert-info mb-3">
        Showing search results for: <strong>"{{ current_search }}"</strong>
        <a href="{{ url_for('list_articles') }}" class="btn btn-sm btn-outline-primary ms-2">Clear search</a>
      </div>
      {% endif %}
      
      {% if current_filter %}
      <div class="alert alert-info mb-3">
        Showing articles filtered by: <strong>{{ current_filter|title }}</strong>
        <a href="{{ url_for('list_articles') }}" class="btn btn-sm btn-outline-primary ms-2">Clear filter</a>
      </div>
      {% endif %}
      
      {% if articles %}
    <div class="row">
      {% for article in articles %}
        <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
          <div class="card article-card h-100">
            <img 
              src="{{ article.cover_image_url(640, 360) }}" 
              data-fallback="{{ article.placeholder_image_url(640, 360) }}"
              class="card-img-top article-card-img" 
              alt="article image" 
              loading="lazy" 
              referrerpolicy="no-referrer" 
              onerror="this.onerror=null;this.src=this.dataset.fallback;" />
            <div class="card-body d-flex flex-column">
              <h4 class="card-title">
                <a href="{{ url_for('article_detail', article_id=article.id) }}" class="text-decoration-none article-card-link">
                  {{ article.title }}
                </a>
              </h4>
              <small class="text-muted d-block mb-2">
                by <strong>{{ article.author.username }}</strong> on {{ article.date_posted.strftime('%Y-%m-%d %H:%M') }}
              </small>
              <p class="card-text">
                {% if article.summary %}
                  {{ article.summary }}
                {% else %}
                  {% set sources_data = article.get_sources() %}
                  {% if sources_data and 'bullets' in sources_data %}
                    Key points from {{ sources_data.sources|length }} sources
                  {% elif sources_data %}
                    Coverage from {{ sources_data|length }} sources
                  {% else %}
                    {{ article.content[:180] + '...' if article.content|length > 180 else article.content }}
                  {% endif %}
                {% endif %}
              </p>
              
              {% if current_user.is_authenticated %}
              <div class="mt-auto">
                <a href="{{ url_for('article_detail', article_id=article.id) }}" class="btn btn-primary btn-sm">
                  Read More ‚Üí
                </a>
                {% if article.source_url %}
                <a href="{{ article.source_url }}" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm ms-2">Read full article</a>
                {% endif %}
                <button 
                  class="btn like-btn btn-sm ms-2 {% if user_reactions.get(article.id) and user_reactions[article.id].liked %}btn-success{% else %}btn-outline-primary{% endif %}" 
                  data-article-id="{{ article.id }}"
                  onclick="toggleLike({{ article.id }})"
                >
                  üëç
                </button>
                <span class="badge bg-primary ms-1 like-count-{{ article.id }}">
                  {{ article_stats[article.id].like_count }}
                </span>
              </div>
              {% else %}
              <a href="{{ url_for('article_detail', article_id=article.id) }}" class="btn btn-primary btn-sm mt-2">
                Read More ‚Üí
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
      {% else %}
        <p>No articles yet. <a href="{{ url_for('add_article') }}">Add the first one</a>.</p>
      {% endif %}
    </div>
  </div>

  {% if current_user.is_authenticated %}
  <script>
    function toggleLike(articleId) {
      fetch(`/article/${articleId}/like`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const likeBtn = document.querySelector(`.like-btn[data-article-id="${articleId}"]`);
          if (data.liked) {
            likeBtn.classList.remove('btn-outline-primary');
            likeBtn.classList.add('btn-success');
          } else {
            likeBtn.classList.remove('btn-success');
            likeBtn.classList.add('btn-outline-primary');
          }
          const likeCount = document.querySelector(`.like-count-${articleId}`);
          likeCount.textContent = data.like_count;
        }
      })
      .catch(error => console.error('Error:', error));
    }
  </script>
  {% endif %}
</div>
{% endblock %}


