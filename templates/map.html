{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    #map {
        height: 600px;
        min-height: 600px;
        width: 100%;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
        margin-bottom: 2rem;
        background: var(--bg);
        position: relative;
    }
    
    @media (min-height: 800px) {
        #map {
            height: calc(100vh - 250px);
            min-height: 600px;
        }
    }
    
    body[data-theme="dark"] #map {
        box-shadow: 0 12px 35px rgba(2, 6, 23, 0.65);
    }
    
    .article-popup {
        max-width: 350px;
        background: var(--card) !important;
        color: var(--fg) !important;
        padding: 0.5rem;
    }
    
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
        background: var(--card) !important;
        color: var(--fg) !important;
        border: 1px solid var(--card-border) !important;
        border-radius: 0.75rem !important;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15) !important;
    }
    
    body[data-theme="dark"] .leaflet-popup-content-wrapper {
        background: var(--card) !important;
        border-color: var(--card-border) !important;
        box-shadow: 0 12px 35px rgba(2, 6, 23, 0.65) !important;
    }
    
    .leaflet-popup-content {
        margin: 0.5rem !important;
        color: var(--fg) !important;
    }
    
    .leaflet-popup-tip {
        background: var(--card) !important;
        border: 1px solid var(--card-border) !important;
    }
    
    body[data-theme="dark"] .leaflet-popup-tip {
        background: var(--card) !important;
        border-color: var(--card-border) !important;
    }
    
    .article-popup img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .article-popup h5 {
        margin: 0.5rem 0;
        font-size: 1.1rem;
        color: var(--fg) !important;
        font-weight: 600;
    }
    
    .article-popup p {
        color: var(--muted) !important;
        font-size: 0.9rem;
        margin: 0.5rem 0;
        line-height: 1.5;
    }
    
    .article-popup small {
        color: var(--muted) !important;
    }
    
    .article-popup .location-badge {
        display: inline-block;
        background: var(--accent);
        color: #051225;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    body[data-theme="dark"] .article-popup .location-badge {
        background: var(--accent);
        color: #051225;
    }
    
    .article-popup .read-more-btn {
        display: inline-block;
        background: var(--accent);
        color: #051225;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-decoration: none;
        font-weight: 600;
        margin-top: 0.5rem;
        transition: transform 0.2s ease, filter 0.2s ease;
    }
    
    .article-popup .read-more-btn:hover {
        transform: translateY(-2px);
        filter: brightness(0.95);
    }
    
    body[data-theme="dark"] .article-popup .read-more-btn {
        background: var(--accent);
        color: #051225;
    }
    
    .map-controls {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 5px 15px rgba(15, 23, 42, 0.05);
    }
    
    .map-controls h3 {
        margin: 0 0 0.5rem 0;
        color: var(--fg);
    }
    
    .map-controls p {
        color: var(--muted);
        margin: 0;
        font-size: 0.9rem;
    }
</style>

<div class="map-controls">
    <h3>üåç World News Map</h3>
    <p>Click on markers to see article previews. Each marker represents a news story with its location.</p>
</div>

<div id="map"></div>

<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map centered on world
        var map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            zoomControl: true
        });

        // Add tile layer with dark mode support
        var isDark = document.body.dataset.theme === 'dark';
        
        // Use OpenStreetMap as default (more reliable)
        var tileUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
        var attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
        
        // Try dark tiles if in dark mode, but fallback to OSM if it fails
        if (isDark) {
            try {
                // Try CartoDB dark tiles
                var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd'
                });
                darkLayer.addTo(map);
                // Test if tiles load, if not use OSM
                darkLayer.on('tileerror', function() {
                    console.log('Dark tiles failed, using OSM');
                    map.removeLayer(darkLayer);
                    L.tileLayer(tileUrl, {
                        maxZoom: 19,
                        attribution: attribution
                    }).addTo(map);
                });
            } catch (e) {
                // Fallback to OSM
                L.tileLayer(tileUrl, {
                    maxZoom: 19,
                    attribution: attribution
                }).addTo(map);
            }
        } else {
            L.tileLayer(tileUrl, {
                maxZoom: 19,
                attribution: attribution
            }).addTo(map);
        }
        
        // Force map to invalidate size after a short delay to ensure it renders
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        // Create marker cluster group
        var markers = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        // Custom icon for news markers
        var newsIcon = L.divIcon({
            className: 'news-marker',
            html: '<div style="background: #0ea5e9; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: #051225; font-weight: bold; font-size: 14px;">üì∞</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // Fetch articles with location
        fetch('/api/articles/with-location')
        .then(response => response.json())
        .then(articles => {
            console.log(`Loaded ${articles.length} articles with location`);
            
            articles.forEach(article => {
                if (article.latitude && article.longitude) {
                    // Create popup content
                    var popupContent = `
                        <div class="article-popup">
                            ${article.photo ? `<img src="${article.photo}" alt="${article.title}" onerror="this.style.display='none'">` : ''}
                            ${article.location_name ? `<span class="location-badge">üìç ${article.location_name}</span>` : ''}
                            <h5>${article.title}</h5>
                            <p>${article.preview || 'No preview available'}</p>
                            <small style="color: var(--muted);">${article.date_posted}</small>
                            <br>
                            <a href="/article/${article.id}" class="read-more-btn">Read Full Article ‚Üí</a>
                        </div>
                    `;
                    
                    // Create marker
                    var marker = L.marker(
                        [article.latitude, article.longitude],
                        { icon: newsIcon }
                    ).bindPopup(popupContent);
                    
                    markers.addLayer(marker);
                }
            });
            
            // Add markers to map
            map.addLayer(markers);
            
            // Fit map to show all markers if there are any
            if (articles.length > 0) {
                var bounds = markers.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        })
        .catch(error => {
            console.error('Error loading articles:', error);
        });

        // Update map theme when theme changes
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    var isDark = document.body.dataset.theme === 'dark';
                    var center = map.getCenter();
                    var zoom = map.getZoom();
                    
                    // Remove all layers
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.TileLayer) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add appropriate tile layer
                    var tileUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
                    var attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
                    
                    if (isDark) {
                        try {
                            var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                                maxZoom: 19,
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                                subdomains: 'abcd'
                            });
                            darkLayer.addTo(map);
                        } catch (e) {
                            L.tileLayer(tileUrl, {
                                maxZoom: 19,
                                attribution: attribution
                            }).addTo(map);
                        }
                    } else {
                        L.tileLayer(tileUrl, {
                            maxZoom: 19,
                            attribution: attribution
                        }).addTo(map);
                    }
                    
                    map.setView(center, zoom);
                    map.invalidateSize();
                }
            });
        });
        
        observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['data-theme']
        });
    });
</script>
{% endblock %}
